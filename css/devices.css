// public/js/customer.js - النسخة الكاملة والنهائية

document.addEventListener('DOMContentLoaded', () => {
    // التأكد من بناء القائمة الجانبية أولاً
    if (typeof buildSidebar === 'function') {
        buildSidebar();
    }
    loadPageData();
    setupEventListeners();
});

const API_BASE_URL = 'http://127.0.0.1:8000/api';
let currentEditingId = null;
let searchTimeout = null;

function setupEventListeners() {
    // الأزرار الثابتة
    
    // نماذج الإضافة والتعديل
    document.getElementById('addCustomerForm')?.addEventListener('submit', e => { e.preventDefault(); saveCustomer(); });

/* تحسينات للبطاقات */
.device-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.device-card.available {
    border-left-color: #28a745;
}

.device-card.busy {
    border-left-color: #dc3545;
    background: linear-gradient(135deg, #fff 0%, #fff5f5 100%);
}

.device-card.maintenance {
    border-left-color: #ffc107;
    opacity: 0.7;
}

/* تحسين العدادات */
.timer-display {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.timer-circle {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
}

.timer-value {
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.timer-info {
    color: rgba(255, 255, 255, 0.9);
    font-size: 12px;
    text-align: center;
}

/* تحسين أزرار الإجراءات */
.action-btn.warning {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.action-btn.warning:hover {
    background-color: #e0a800 !important;
}

.action-btn.danger {
    background-color: #dc3545 !important;
    color: white !important;
}

.action-btn.danger:hover {
    background-color: #c82333 !important;
}

/* تحسين البوفيه */
.buffet-content {
    display: grid;
    grid-template-columns: 1fr 1fr 300px;
    gap: 20px;
    padding: 20px;
}

.category-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.category-btn {
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.category-btn.active,
.category-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-2px);
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.product-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.product-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.product-icon {
    font-size: 2rem;
    color: #667eea;
    margin-bottom: 10px;
}

.product-card h4 {
    margin: 10px 0;
    font-size: 14px;
    color: #333;
}

.product-card .price {
    color: #28a745;
    font-weight: bold;
    font-size: 16px;
    margin: 5px 0;
}

.product-card .stock {
    color: #6c757d;
    font-size: 12px;
    margin-bottom: 10px;
}

.add-to-order-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    width: 100%;
}

.add-to-order-btn:hover:not(:disabled) {
    background: #218838;
    transform: translateY(-1px);
}

.add-to-order-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

/* تحسين ملخص الطلبات */
.order-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    height: fit-content;
}

.order-summary h4 {
    margin-bottom: 15px;
    color: #333;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
}

#buffetOrderList {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
    max-height: 300px;
    overflow-y: auto;
}

.order-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px dashed #dee2e6;
}

.order-item:last-child {
    border-bottom: none;
}

.item-name {
    font-weight: 500;
    color: #333;
}

.item-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.qty-btn {
    background: #667eea;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qty-btn:hover {
    background: #5a67d8;
}

.quantity {
    font-weight: bold;
    min-width: 20px;
    text-align: center;
}

.item-price {
    color: #28a745;
    font-weight: bold;
    font-size: 14px;
}

.remove-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 6px;
    cursor: pointer;
    font-size: 10px;
}

.remove-btn:hover {
    background: #c82333;
}

.summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
    color: #333;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border: 2px solid #28a745;
}

.no-items {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 20px;
}

.no-categories,
.no-products {
    text-align: center;
    color: #6c757d;
    padding: 20px;
    font-style: italic;
}

/* تحسين معلومات الأسعار */
.device-prices-info {
    background: #e3f2fd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.price-info {
    display: flex;
    justify-content: space-between;
    gap: 15px;
}

.price-info span {
    background: white;
    padding: 8px 12px;
    border-radius: 5px;
    font-weight: 500;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

/* تحسين تفاصيل الجهاز */
.device-details {
    padding: 20px;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-item .label {
    font-weight: 600;
    color: #555;
}

.detail-item .value {
    color: #333;
    font-weight: 500;
}

.status-available {
    color: #28a745 !important;
    font-weight: bold;
}

.status-busy {
    color: #dc3545 !important;
    font-weight: bold;
}

.status-maintenance {
    color: #ffc107 !important;
    font-weight: bold;
}

/* تحسين النموذج */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.current-time-display {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    color: #495057;
}

/* تحسين الاستجابة */
@media (max-width: 768px) {
    .buffet-content {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .price-info {
        flex-direction: column;
        gap: 10px;
    }
    
    .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}

/* تحسين الحالة الفارغة */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #6c757d;
}

.loading-spinner i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #667eea;
}

.loading-spinner p {
    font-size: 16px;
    margin: 0;
}

.no-data {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: #6c757d;
    text-align: center;
}

.no-data i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.no-data h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #495057;
}

.no-data p {
    font-size: 1rem;
    margin: 0;
}
    document.getElementById('editCustomerForm')?.addEventListener('submit', e => { e.preventDefault(); updateCustomer(); });
    
    // البحث
    document.getElementById('customerSearchInput')?.addEventListener('keyup', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadPageData(e.target.value);
        }, 500);
    });

    // استخدام Event Delegation للأزرار الديناميكية
    document.body.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;

        if (button.classList.contains('close-btn') || button.classList.contains('btn-cancel')) {
            button.closest('.modal')?.classList.remove('active');
        }

        const { action, id } = button.dataset;
        if (!action || !id) return;
        
        const numericId = parseInt(id, 10);
        if (action === 'edit') editCustomer(numericId);
        if (action === 'delete') deleteCustomer(numericId);
        if (action === 'view-details') viewCustomerDetails(numericId);
    });
}

async function loadPageData(searchTerm = '') {
    showNotification('جاري تحميل بيانات العملاء...', 'info');
    try {
        const url = searchTerm ? `customers?search=${searchTerm}` : 'customers';
        const customers = await sendRequest(url, 'GET');
        
        renderCustomerTable(customers);
        updateSummaryCards(customers);
    } catch (error) {
        showNotification('فشل تحميل البيانات', 'error');
    }
}

function renderCustomerTable(customers) {
    const tableBody = document.getElementById('customerTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    if (!customers || customers.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="no-data">لا يوجد عملاء مسجلين.</td></tr>`;
        return;
    }
    customers.forEach(customer => {
        const row = document.createElement('tr');
        const balanceClass = parseFloat(customer.balance) > 0 ? 'text-danger' : 'text-success';
        const lastTransaction = customer.last_transaction ? new Date(customer.last_transaction).toLocaleDateString('ar-EG') : 'لا يوجد';
        
        row.innerHTML = `
            <td>${customer.customer_code}</td>
            <td>${customer.name}</td>
            <td>${customer.phone || '-'}</td>
            <td class="${balanceClass}">${parseFloat(customer.balance).toFixed(2)} ج</td>
            <td>${lastTransaction}</td>
            <td><span class="status-badge ${customer.is_active ? 'available' : 'busy'}">${customer.is_active ? 'نشط' : 'غير نشط'}</span></td>
            <td class="actions">
                <button class="action-btn view" data-action="view-details" data-id="${customer.id}" title="تفاصيل"><i class="fas fa-info-circle"></i></button>
                <button class="action-btn edit" data-action="edit" data-id="${customer.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                <button class="action-btn delete" data-action="delete" data-id="${customer.id}" title="حذف"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function updateSummaryCards(customers) {
    const totalDue = customers.reduce((sum, cust) => sum + parseFloat(cust.balance), 0);
    document.getElementById('totalDueAmount').textContent = totalDue.toFixed(2);
    document.getElementById('totalCustomersCount').textContent = `${customers.length} عملاء`;
}

async function saveCustomer() {
    const form = document.getElementById('addCustomerForm');
    const data = {
        name: form.customerName.value,
        phone: form.customerPhone.value,
        notes: form.customerNotes.value
    };
    await handleRequest(sendRequest('customers', 'POST', data), 'تمت إضافة العميل بنجاح', () => {
        loadPageData();
        closeModal('addCustomerModal');
        form.reset();
    });
}

async function editCustomer(id) {
    try {
        const customer = await sendRequest(`customers/${id}`, 'GET');
        if (!customer) return;
        
        currentEditingId = id;
        const form = document.getElementById('editCustomerForm');
        form.editCustomerName.value = customer.name;
        form.editCustomerPhone.value = customer.phone;
        form.editCustomerNotes.value = customer.notes;
        form.editCustomerIsActive.checked = customer.is_active;
        openModal('editCustomerModal');
    } catch (error) {
        showNotification('فشل في جلب بيانات العميل', 'error');
    }
}

async function updateCustomer() {
    if (!currentEditingId) return;
    const form = document.getElementById('editCustomerForm');
    const data = {
        name: form.editCustomerName.value,
        phone: form.editCustomerPhone.value,
        notes: form.editCustomerNotes.value,
        is_active: form.editCustomerIsActive.checked
    };
    await handleRequest(sendRequest(`customers/${currentEditingId}`, 'PUT', data), 'تم تحديث البيانات بنجاح', () => {
        loadPageData();
        closeModal('editCustomerModal');
    });
}

async function deleteCustomer(id) {
    if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
        await handleRequest(sendRequest(`customers/${id}`, 'DELETE'), 'تم حذف العميل بنجاح', loadPageData);
    }
}

async function viewCustomerDetails(id) {
    try {
        const customer = await sendRequest(`customers/${id}`, 'GET');
        if (!customer) return;
        document.getElementById('detailCustomerCode').textContent = customer.customer_code;
        document.getElementById('detailCustomerName').textContent = customer.name;
        document.getElementById('detailCustomerPhone').textContent = customer.phone || '-';
        document.getElementById('detailCustomerBalance').textContent = `${parseFloat(customer.balance).toFixed(2)} ج`;
        document.getElementById('detailCustomerSince').textContent = new Date(customer.created_at).toLocaleDateString('ar-EG');
        document.getElementById('detailLastTransaction').textContent = customer.last_transaction ? new Date(customer.last_transaction).toLocaleDateString('ar-EG') : 'لا يوجد';
        document.getElementById('detailCustomerNotes').textContent = customer.notes || 'لا يوجد';
        openModal('customerDetailsModal');
    } catch (error) {
        showNotification('فشل في عرض التفاصيل', 'error');
    }
}

// --- دوال المساعدة ---
function openModal(modalId) { document.getElementById(modalId)?.classList.add('active'); }
function closeModal(modalId) { document.getElementById(modalId)?.classList.remove('active'); }
async function sendRequest(endpoint, method, body = null) { try { const options = { method, headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, }; if (body) { options.body = JSON.stringify(body); } const response = await fetch(`${API_BASE_URL}/${endpoint}`, options); const data = await response.json(); if (!response.ok) { const errorMessages = Object.values(data.errors || {}).flat().join('\n'); throw new Error(errorMessages || data.message || 'حدث خطأ غير متوقع'); } return data; } catch (error) { console.error(`API Error:`, error); throw error; } }
async function handleRequest(requestPromise, successMessage, callback) { try { await requestPromise; if (successMessage) showNotification(successMessage, 'success'); if (callback) await callback(); } catch (error) { showNotification(`فشل: ${error.message}`, 'error'); } }
function showNotification(message, type = 'info') { const container = document.createElement('div'); container.className = `notification show ${type}`; const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' }; container.innerHTML = `<i class="fas ${icons[type]}"></i><span style="margin-right: 10px;">${message}</span>`; document.body.appendChild(container); if (!document.getElementById('notification-styles')) { const style = document.createElement('style'); style.id = 'notification-styles'; style.textContent = `.notification { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; z-index: 10000; transform: translateX(calc(100% + 20px)); transition: transform 0.5s ease-in-out; } .notification.show { transform: translateX(0); } .notification.success { border-left: 5px solid #28a745; } .notification.error { border-left: 5px solid #dc3545; } .notification.info { border-left: 5px solid #17a2b8; }`; document.head.appendChild(style); } setTimeout(() => { container.classList.remove('show'); setTimeout(() => container.remove(), 500); }, 4000); }